<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Take Quiz</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style2.css') }}">
  <style>
    .container { max-width: 800px; margin: 20px auto; padding: 20px; background: #fff; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);}
    h2 { text-align: center; color: #2c3e50; }
    .question { margin: 15px 0; }
    .option { display: block; padding: 5px 10px; margin-left: 20px; cursor: pointer; border-radius: 5px; border: 1px solid #ddd; }
    .option.correct { background: #c8f7c5; }
    .option.wrong { background: #f7c5c5; }
    #timer { font-weight: bold; font-size: 18px; color: darkred; margin-top: 10px; text-align: center; }
    button { margin-top: 10px; padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer; }
    button:disabled { background: #ccc; cursor: not-allowed; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Student Quiz</h2>

    <div>
      <label>Enter your name: </label>
      <input type="text" id="studentName" placeholder="Your Name">
      <button id="startBtn">Start Quiz</button>
    </div>

    <div id="timer"></div>

    <form id="quizForm" style="display:none;">
      <div id="quiz"></div>
      <button type="button" id="submitBtn">Submit Quiz</button>
    </form>

    <div id="result"></div>
  </div>

  <script>
    let questions = [];
    let timerInterval;
    let quizDuration = 0;
    let quizId = "";

    async function startQuiz() {
      const name = document.getElementById("studentName").value.trim();
      if (!name) { alert("Please enter your name"); return; }

      // Start quiz via backend
      const startRes = await fetch('/start_quiz', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ student: name })
      });
      const startData = await startRes.json();
      quizId = startData.quiz_id;
      quizDuration = startData.duration;

      // Check if this quiz was already submitted
      if (localStorage.getItem(`quizSubmitted_${quizId}`) === "true") {
        alert("You have already submitted this quiz!");
        return;
      }

      // Save start time and student info per quiz
      localStorage.setItem(`quizStartedAt_${quizId}`, Date.now());
      localStorage.setItem("studentName", name);

      document.getElementById("quizForm").style.display = "block";
      document.getElementById("startBtn").disabled = true;

      // Load questions
      const res = await fetch('/get_questions');
      questions = await res.json();
      localStorage.setItem(`quizQuestions_${quizId}`, JSON.stringify(questions));

      renderQuestions(questions);
      startTimer();
    }

    function renderQuestions(qs) {
      let html = "";
      qs.forEach((q, i) => {
        html += `<div class="question">
                  <p>${i+1}. ${q.question}</p>`;
        q.options.forEach(opt => {
          html += `<label class="option">
                    <input type="radio" name="q${i}" value="${opt}"> ${opt}
                  </label>`;
        });
        html += "</div>";
      });
      document.getElementById("quiz").innerHTML = html;
    }

    function startTimer() {
      const startedAt = parseInt(localStorage.getItem(`quizStartedAt_${quizId}`));
      const endAt = startedAt + quizDuration * 1000;

      timerInterval = setInterval(() => {
        const now = Date.now();
        const remaining = Math.floor((endAt - now) / 1000);

        if (remaining <= 0) {
          clearInterval(timerInterval);
          localStorage.removeItem(`quizStartedAt_${quizId}`);
          document.getElementById("timer").innerText = "Timeâ€™s up!";
          submitQuiz();
        } else {
          document.getElementById("timer").innerText =
            `Time left: ${Math.floor(remaining/60)}m ${remaining%60}s`;
        }
      }, 1000);
    }

    async function submitQuiz() {
      clearInterval(timerInterval);
      localStorage.removeItem(`quizStartedAt_${quizId}`);

      let answers = [];
      questions.forEach((q, i) => {
        let chosen = document.querySelector(`input[name="q${i}"]:checked`);
        answers.push(chosen ? chosen.value : "");
      });

      const student = localStorage.getItem("studentName");

      const res = await fetch('/submit_quiz', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ student: student, answers: answers, quiz_id: quizId })
      });
      const data = await res.json();

      document.getElementById("result").innerHTML =
        `<h3>Your Score: ${data.score}/${data.total}</h3>
         <p><a href="/leaderboard">View Leaderboard</a></p>`;

      questions.forEach((q, i) => {
        let chosen = document.querySelector(`input[name="q${i}"]:checked`);
        let options = document.querySelectorAll(`input[name="q${i}"]`);
        options.forEach(opt => {
          let label = opt.parentElement;
          if (opt.value === q.answer) label.classList.add("correct");
          if (chosen && opt === chosen && chosen.value !== q.answer) {
            label.classList.add("wrong");
          }
        });
      });

      localStorage.setItem(`quizSubmitted_${quizId}`, "true");
      document.getElementById("submitBtn").disabled = true;
    }

    document.getElementById("startBtn").addEventListener("click", startQuiz);
    document.getElementById("submitBtn").addEventListener("click", submitQuiz);

    window.onload = async function() {
      // If quiz already started, resume it
      const name = localStorage.getItem("studentName");
      if (!name) return;

      const res = await fetch('/get_timer');
      const data = await res.json();
      quizDuration = data.duration;

      // Load the last quizId from startData
      const quizKeys = Object.keys(localStorage).filter(k => k.startsWith("quizStartedAt_"));
      if (quizKeys.length > 0) {
        quizId = quizKeys[quizKeys.length - 1];
        quizId = quizId.replace("quizStartedAt_", "");
      } else return;

      if (localStorage.getItem(`quizSubmitted_${quizId}`) === "true") {
        document.getElementById("result").innerHTML =
          `<p>You have already submitted this quiz.</p>
           <p><a href="/leaderboard">View Leaderboard</a></p>`;
        document.getElementById("startBtn").disabled = true;
        return;
      }

      const startedAt = localStorage.getItem(`quizStartedAt_${quizId}`);
      if (startedAt) {
        document.getElementById("studentName").value = name;
        document.getElementById("quizForm").style.display = "block";
        document.getElementById("startBtn").disabled = true;

        questions = JSON.parse(localStorage.getItem(`quizQuestions_${quizId}`) || "[]");
        renderQuestions(questions);
        startTimer();
      }
    }
  </script>
</body>
</html>
