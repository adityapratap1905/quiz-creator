<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Take Quiz</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style2.css') }}">
</head>
<body>
  <div class="container">
    <h2>Student Quiz</h2>

    <div>
      <label>Enter your name: </label>
      <input type="text" id="studentName" placeholder="Your Name">
      <button id="startBtn" onclick="startQuiz()">Start Quiz</button>
    </div>

    <div id="timer"></div>

    <form id="quizForm" style="display:none;">
      <div id="quiz"></div>
      <button type="button" onclick="submitQuiz()">Submit Quiz</button>
    </form>

    <div id="result"></div>
  </div>

  <script>
    let questions = [];
    let timerInterval;
    let quizDuration = 0;

    async function fetchTimer() {
      const res = await fetch('/get_timer');
      const data = await res.json();
      quizDuration = data.duration;
    }

    async function startQuiz() {
      const name = document.getElementById("studentName").value.trim();
      if (!name) { alert("Please enter your name"); return; }

      if (localStorage.getItem("quizStartedAt")) {
        alert("You already started the quiz!");
        return;
      }

      localStorage.setItem("quizStartedAt", Date.now());
      localStorage.setItem("studentName", name);

      document.getElementById("quizForm").style.display = "block";
      document.getElementById("startBtn").disabled = true;

      const res = await fetch('/get_questions');
      questions = await res.json();
      localStorage.setItem("quizQuestions", JSON.stringify(questions));

      renderQuestions(questions);
      startTimer();
    }

    function renderQuestions(qs) {
      let html = "";
      qs.forEach((q, i) => {
        html += `<div class="question">
                  <p>${i+1}. ${q.question}</p>`;
        q.options.forEach(opt => {
          html += `<label class="option">
                    <input type="radio" name="q${i}" value="${opt}"> ${opt}
                  </label>`;
        });
        html += "</div>";
      });
      document.getElementById("quiz").innerHTML = html;
    }

    function startTimer() {
      const startedAt = parseInt(localStorage.getItem("quizStartedAt"));
      const endAt = startedAt + quizDuration * 1000;

      timerInterval = setInterval(() => {
        const now = Date.now();
        const remaining = Math.floor((endAt - now) / 1000);

        if (remaining <= 0) {
          clearInterval(timerInterval);
          localStorage.removeItem("quizStartedAt");
          document.getElementById("timer").innerText = "Timeâ€™s up!";
          submitQuiz();
        } else {
          document.getElementById("timer").innerText =
            `Time left: ${Math.floor(remaining/60)}m ${remaining%60}s`;
        }
      }, 1000);
    }

    async function submitQuiz() {
      clearInterval(timerInterval);
      localStorage.removeItem("quizStartedAt");

      let answers = [];
      questions.forEach((q, i) => {
        let chosen = document.querySelector(`input[name="q${i}"]:checked`);
        answers.push(chosen ? chosen.value : "");
      });

      const student = localStorage.getItem("studentName");

      const res = await fetch('/submit_quiz', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ student: student, answers: answers })
      });
      const data = await res.json();

      document.getElementById("result").innerHTML =
        `<h3>Your Score: ${data.score}/${data.total}</h3>
         <p><a href="/leaderboard">View Leaderboard</a></p>`;

      questions.forEach((q, i) => {
        let chosen = document.querySelector(`input[name="q${i}"]:checked`);
        let options = document.querySelectorAll(`input[name="q${i}"]`);
        options.forEach(opt => {
          let label = opt.parentElement;
          if (opt.value === q.answer) label.classList.add("correct");
          if (chosen && opt === chosen && chosen.value !== q.answer) {
            label.classList.add("wrong");
          }
        });
      });

      localStorage.setItem("quizSubmitted", "true");
    }

    window.onload = async function() {
      await fetchTimer();

      if (localStorage.getItem("quizSubmitted") === "true") {
        document.getElementById("result").innerHTML =
          `<p>You have already submitted the quiz.</p>
           <p><a href="/leaderboard">View Leaderboard</a></p>`;
        document.getElementById("startBtn").disabled = true;
        return;
      }

      if (localStorage.getItem("quizStartedAt")) {
        document.getElementById("studentName").value =
          localStorage.getItem("studentName");
        document.getElementById("quizForm").style.display = "block";
        document.getElementById("startBtn").disabled = true;

        questions = JSON.parse(localStorage.getItem("quizQuestions") || "[]");
        renderQuestions(questions);

        startTimer();
      }
    }
  </script>
</body>
</html>
