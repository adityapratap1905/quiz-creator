<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Take Quiz</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .question { margin: 15px 0; }
    .option { margin-left: 20px; cursor: pointer; display: block; padding: 5px; border-radius: 5px; }
    .option.correct { background: #c8f7c5; }  /* green */
    .option.wrong { background: #f7c5c5; }    /* red */
    #timer { font-weight: bold; font-size: 18px; color: darkred; }
  </style>
</head>
<body>
  <h2>Student Quiz</h2>

  <div>
    <label>Enter your name: </label>
    <input type="text" id="studentName" placeholder="Your Name">
    <button id="startBtn" onclick="startQuiz()">Start Quiz</button>
  </div>

  <div id="timer"></div>
  <form id="quizForm" style="display:none;">
    <div id="quiz"></div>
    <button type="button" onclick="submitQuiz()">Submit Quiz</button>
  </form>

  <div id="result"></div>

  <script>
    let questions = [];
    let timerInterval;
    let quizDuration = 0; // seconds (set by creator)

    // --- fetch quiz duration from backend ---
    async function fetchTimer() {
      const res = await fetch('/get_timer');
      const data = await res.json();
      quizDuration = data.duration;  // e.g. 300 for 5 min
    }

    async function startQuiz() {
      const name = document.getElementById("studentName").value.trim();
      if (!name) { alert("Please enter your name"); return; }

      // If already started, block restart
      if (localStorage.getItem("quizStartedAt")) {
        alert("You already started the quiz!");
        return;
      }

      // Save start time in localStorage
      localStorage.setItem("quizStartedAt", Date.now());
      localStorage.setItem("studentName", name);

      document.getElementById("quizForm").style.display = "block";
      document.getElementById("startBtn").disabled = true;

      // load questions
      const res = await fetch('/get_questions');
      questions = await res.json();
      let html = "";
      questions.forEach((q, i) => {
        html += `<div class="question">
                  <p>${i+1}. ${q.question}</p>`;
        q.options.forEach(opt => {
          html += `<label class="option">
                    <input type="radio" name="q${i}" value="${opt}"> ${opt}
                  </label>`;
        });
        html += "</div>";
      });
      document.getElementById("quiz").innerHTML = html;

      startTimer();
    }

    function startTimer() {
      const startedAt = parseInt(localStorage.getItem("quizStartedAt"));
      const endAt = startedAt + quizDuration * 1000;

      timerInterval = setInterval(() => {
        const now = Date.now();
        const remaining = Math.floor((endAt - now) / 1000);

        if (remaining <= 0) {
          clearInterval(timerInterval);
          localStorage.removeItem("quizStartedAt");
          document.getElementById("timer").innerText = "Timeâ€™s up!";
          submitQuiz();
        } else {
          document.getElementById("timer").innerText =
            `Time left: ${Math.floor(remaining/60)}m ${remaining%60}s`;
        }
      }, 1000);
    }

    async function submitQuiz() {
      clearInterval(timerInterval);
      localStorage.removeItem("quizStartedAt");

      let answers = [];
      questions.forEach((q, i) => {
        let chosen = document.querySelector(`input[name="q${i}"]:checked`);
        answers.push(chosen ? chosen.value : "");
      });

      const student = localStorage.getItem("studentName");

      const res = await fetch('/submit_quiz', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ student: student, answers: answers })
      });
      const data = await res.json();

      document.getElementById("result").innerHTML =
        `<h3>Your Score: ${data.score}/${data.total}</h3>
         <p><a href="/leaderboard">View Leaderboard</a></p>`;

      // Highlight correct/wrong
      questions.forEach((q, i) => {
        let chosen = document.querySelector(`input[name="q${i}"]:checked`);
        let options = document.querySelectorAll(`input[name="q${i}"]`);
        options.forEach(opt => {
          let label = opt.parentElement;
          if (opt.value === q.answer) label.classList.add("correct");
          if (chosen && opt === chosen && chosen.value !== q.answer) {
            label.classList.add("wrong");
          }
        });
      });
    }

    // --- Resume quiz if already started ---
    window.onload = async function() {
      await fetchTimer(); // load creator-set duration

      if (localStorage.getItem("quizStartedAt")) {
        document.getElementById("studentName").value =
          localStorage.getItem("studentName");
        document.getElementById("quizForm").style.display = "block";
        document.getElementById("startBtn").disabled = true;

        // load questions again
        const res = await fetch('/get_questions');
        questions = await res.json();
        let html = "";
        questions.forEach((q, i) => {
          html += `<div class="question">
                    <p>${i+1}. ${q.question}</p>`;
          q.options.forEach(opt => {
            html += `<label class="option">
                      <input type="radio" name="q${i}" value="${opt}"> ${opt}
                    </label>`;
          });
          html += "</div>";
        });
        document.getElementById("quiz").innerHTML = html;

        startTimer(); // continue timer
      }
    }
  </script>
</body>
</html>
