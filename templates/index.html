<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Take Quiz</title>
  <link rel="stylesheet" href="/static/css/style.css">
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .question { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; border-radius: 5px; }
    .question p { font-weight: bold; }
    .options label { display: block; margin-top: 5px; cursor: pointer; }
    #timer { font-size: 18px; font-weight: bold; margin-bottom: 10px; }
    #leaderboard { margin-top: 20px; }
    #leaderboard table { width: 100%; border-collapse: collapse; }
    #leaderboard th, #leaderboard td { border: 1px solid #ccc; padding: 5px; text-align: center; }
  </style>
</head>
<body>
  <h2>Take Quiz</h2>

  <div>
    <label>Your Name: <input type="text" id="studentName"></label>
    <button onclick="startQuiz()">Start Quiz</button>
  </div>

  <div id="timer"></div>
  <form id="quizForm"></form>
  <button onclick="submitQuiz()">Submit Quiz</button>

  <div id="leaderboard">
    <h3>Leaderboard</h3>
    <table>
      <thead>
        <tr><th>Student</th><th>Score</th><th>Total</th><th>Time</th></tr>
      </thead>
      <tbody id="leaderboardBody"></tbody>
    </table>
  </div>

<script>
let quizId = null;
let timerInterval;
let totalQuestions = 0;

async function startQuiz() {
  const studentName = document.getElementById("studentName").value.trim();
  if (!studentName) { alert("Enter your name!"); return; }

  const res = await fetch("/start_quiz", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ student: studentName })
  });
  const data = await res.json();
  quizId = data.quiz_id;

  await loadQuestions();
  startTimer(data.duration);
  loadLeaderboard();
}

async function loadQuestions() {
  const res = await fetch("/get_questions");
  const questions = await res.json();
  totalQuestions = questions.length;

  const quizForm = document.getElementById("quizForm");
  quizForm.innerHTML = "";

  questions.forEach((q, idx) => {
    const div = document.createElement("div");
    div.className = "question";
    div.dataset.index = idx;

    let html = `<p>${idx + 1}. ${q.question}</p><div class="options">`;
    q.options.forEach(opt => {
      html += `<label><input type="radio" name="q${idx}" value="${opt}"> ${opt}</label>`;
    });
    html += `</div>`;
    div.innerHTML = html;
    quizForm.appendChild(div);
  });
}

function startTimer(duration) {
  let time = duration;
  const timerEl = document.getElementById("timer");

  clearInterval(timerInterval);
  timerInterval = setInterval(() => {
    const minutes = Math.floor(time / 60);
    const seconds = time % 60;
    timerEl.textContent = `Time Left: ${minutes}:${seconds < 10 ? '0'+seconds : seconds}`;
    time--;

    if (time < 0) {
      clearInterval(timerInterval);
      alert("Time's up! Submitting quiz...");
      submitQuiz();
    }
  }, 1000);
}

async function submitQuiz() {
  clearInterval(timerInterval);

  const studentName = document.getElementById("studentName").value.trim();
  const answers = [];

  document.querySelectorAll(".question").forEach((qDiv, idx) => {
    const selected = qDiv.querySelector(`input[name="q${idx}"]:checked`);
    answers.push(selected ? selected.value.trim() : "");
  });

  const res = await fetch("/submit_quiz", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ student: studentName, quiz_id: quizId, answers })
  });

  const data = await res.json();
  alert(`You scored ${data.score} out of ${data.total}`);
  loadLeaderboard();
}

async function loadLeaderboard() {
  const res = await fetch("/leaderboard_json");
  const data = await res.json();

  const tbody = document.getElementById("leaderboardBody");
  tbody.innerHTML = "";

  data.forEach(r => {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${r.student}</td><td>${r.score}</td><td>${r.total}</td><td>${r.timestamp ? new Date(r.timestamp).toLocaleString() : ''}</td>`;
    tbody.appendChild(tr);
  });
}
</script>
</body>
</html>
